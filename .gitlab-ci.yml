---
###############################################################################
# Define all YAML node anchors
###############################################################################
.node_anchors:
  # `stage`
  stage_lint: &stage_lint 'lint'
  stage_release: &stage_release 'release'
  # `image`
  image_node: &image_node 'node:12-buster-slim'
  # `before_script`
  before_script_image_node: &before_script_image_node
    - 'apt-get update
       && apt-get install -y --no-install-recommends git-core ca-certificates'
  # `only` (also used for `except` where applicable)
  only_branch_master: &only_branch_master ['master']

###############################################################################
# Define stages
###############################################################################
stages:
  - 'lint'
  - 'release'

###############################################################################
# `lint` stage: `commitlint`
###############################################################################
commitlint:
  stage: *stage_lint
  image: *image_node
  before_script: *before_script_image_node
  script:
    # Install and run `commitlint`
    # Run `git fetch` to get access to `origin/master`
    - 'git fetch --all'
    - 'npm install -D @commitlint/config-conventional
                      @commitlint/cli'
    - 'npx commitlint --from "$(git merge-base origin/master HEAD)"
                      --to   "${CI_COMMIT_SHA}"'

###############################################################################
# `release` stage: `semantic-release`
###############################################################################
semantic-release:
  only: *only_branch_master
  stage: *stage_release
  image: *image_node
  before_script: *before_script_image_node
  script:
    - 'npm install -g semantic-release
                      @semantic-release/gitlab
                      @semantic-release/changelog
                      @semantic-release/git'
    - 'semantic-release'
